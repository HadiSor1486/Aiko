<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="https://i.imgur.com/1HU9XPx.jpeg">
    <link rel="apple-touch-icon" href="https://i.imgur.com/1HU9XPx.jpeg">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For Aiko</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <style>
        :root {
            --primary: #ff9ecd;
            --primary-light: #ffc4e1;
            --primary-dark: #ff7eb8;
            --secondary: #a8d8ea;
            --secondary-light: #c5f0f7;
            --accent: #ffd93d;
            --accent-light: #fff0a3;
            --bg-gradient-start: #fff5f8;
            --bg-gradient-end: #e8f4f8;
            --text-dark: #5a4a5a;
            --text-light: #8a7a8a;
            --white: #ffffff;
            --shadow: rgba(255, 158, 205, 0.25);
            --shadow-soft: rgba(0, 0, 0, 0.08);
        }

        /* Night Theme - Cute & Magical */
        body.theme-night {
            --primary: #e8b4e0;
            --primary-light: #f5d5f0;
            --primary-dark: #d49acd;
            --secondary: #a8d8ea;
            --secondary-light: #c5f0f7;
            --accent: #ffd1dc;
            --accent-light: #ffe8f0;
            --bg-gradient-start: #2d1b4e;
            --bg-gradient-end: #1a0f2e;
            --text-dark: #ffe8f5;
            --text-light: #c9b8d4;
            --white: #3d2b5e;
            --shadow: rgba(232, 180, 224, 0.3);
            --shadow-soft: rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Quicksand', 'Nunito', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
            transition: background 0.5s ease;
        }

        /* Floating hearts animation - only in default theme */
        .hearts-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        body.theme-night .hearts-container {
            display: none;
        }

        .heart {
            position: absolute;
            font-size: 20px;
            opacity: 0.3;
            animation: float-up 15s infinite ease-in;
        }

        @keyframes float-up {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.3;
            }
            90% {
                opacity: 0.3;
            }
            100% {
                transform: translateY(-100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Magical Night Theme Elements */
        .night-magic-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
            display: none;
        }

        body.theme-night .night-magic-container {
            display: block;
        }

        /* Twinkling Stars */
        .magic-star {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.8), 0 0 20px 4px rgba(232, 180, 224, 0.5);
            animation: magic-twinkle 2s infinite ease-in-out;
        }

        @keyframes magic-twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.3); }
        }

        /* Shooting Stars */
        .shooting-star {
            position: absolute;
            width: 100px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #fff, #e8b4e0, transparent);
            border-radius: 50%;
            opacity: 0;
            animation: shoot-star 3s linear infinite;
            transform: rotate(-45deg);
        }

        @keyframes shoot-star {
            0% {
                transform: translateX(-100px) translateY(100px) rotate(-45deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(100vw) translateY(-100vh) rotate(-45deg);
                opacity: 0;
            }
        }

        /* Floating Moons */
        .floating-moon {
            position: absolute;
            font-size: 30px;
            opacity: 0.4;
            animation: float-moon 20s infinite ease-in-out;
            filter: drop-shadow(0 0 10px rgba(232, 180, 224, 0.6));
        }

        @keyframes float-moon {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-30px) rotate(10deg);
            }
        }

        /* Sparkles */
        .sparkle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #fff 0%, #e8b4e0 50%, transparent 70%);
            border-radius: 50%;
            animation: sparkle-dance 4s infinite ease-in-out;
        }

        @keyframes sparkle-dance {
            0%, 100% { 
                opacity: 0; 
                transform: scale(0) rotate(0deg); 
            }
            50% { 
                opacity: 1; 
                transform: scale(1) rotate(180deg); 
            }
        }

        /* Fireworks Canvas */
        .fireworks-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            display: none;
        }

        .fireworks-canvas.active {
            display: block;
        }

        /* Welcome Message Overlay */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
        }

        body.theme-night .welcome-overlay {
            background: rgba(45, 27, 78, 0.95);
        }

        .welcome-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .welcome-box {
            background: var(--white);
            border-radius: 30px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px var(--shadow);
            position: relative;
            transform: scale(0.9);
            transition: transform 0.5s ease;
            border: 3px solid var(--primary-light);
        }

        .welcome-overlay.active .welcome-box {
            transform: scale(1);
        }

        .welcome-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: none;
            background: var(--primary-light);
            color: var(--primary-dark);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .welcome-close:hover {
            background: var(--primary);
            color: white;
            transform: rotate(90deg);
        }

        .welcome-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 15px;
        }

        .welcome-text {
            font-size: 18px;
            line-height: 1.6;
            color: var(--text-dark);
        }

        /* To-Do List Button - Top Left */
        .todo-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
            animation: todoPulse 2s ease-in-out infinite;
        }

        @keyframes todoPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(108, 92, 231, 0.6);
            }
        }

        .todo-btn:hover {
            opacity: 1;
            transform: scale(1.15);
            animation: none;
        }

        /* Study Timer Button - Below Todo */
        .study-timer-btn {
            position: fixed;
            top: 70px;
            left: 14px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ffb7d5, #ff9ecd);
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 158, 205, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.3);
            animation: studyTimerPulse 2.5s ease-in-out infinite;
        }

        @keyframes studyTimerPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(255, 158, 205, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(255, 158, 205, 0.7), inset 0 0 15px rgba(255, 255, 255, 0.5);
            }
        }

        .study-timer-btn:hover {
            opacity: 1;
            transform: scale(1.15);
            animation: none;
        }

        /* Gift Button - Top Right */
        .gift-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0.8;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 217, 61, 0.4);
            animation: giftPulse 2s ease-in-out infinite;
        }

        .gift-btn.visible {
            display: flex;
        }

        @keyframes giftPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(255, 217, 61, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(255, 217, 61, 0.6);
            }
        }

        .gift-btn:hover {
            opacity: 1;
            transform: scale(1.15);
            animation: none;
        }

        /* Duaa Button - Cute Pink/White */
        .duaa-btn {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid white;
            background: linear-gradient(135deg, #ffb7d5, #ff9ecd);
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            opacity: 0.9;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 158, 205, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.3);
            animation: duaaPulse 2s ease-in-out infinite 0.5s;
        }

        .duaa-btn.visible {
            display: flex;
        }

        @keyframes duaaPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(255, 158, 205, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(255, 158, 205, 0.7), inset 0 0 15px rgba(255, 255, 255, 0.5);
            }
        }

        .duaa-btn:hover {
            opacity: 1;
            transform: scale(1.15);
            animation: none;
        }

        /* Notification Bell Button - Dynamic Position */
        .notif-btn {
            position: fixed;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #ff6b9d, #ffa6c1);
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            opacity: 0;
            visibility: hidden;
            transform: scale(0) rotate(-180deg);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
        }

        /* Position when duaa exists (below duaa at 140px) */
        .notif-btn.position-with-duaa {
            top: 140px;
        }

        /* Position when no duaa (below gift at 80px) */
        .notif-btn.position-no-duaa {
            top: 80px;
        }

        .notif-btn.visible {
            opacity: 0.8;
            visibility: visible;
            transform: scale(1) rotate(0deg);
            animation: bellPulse 2s ease-in-out infinite 1s;
        }

        @keyframes bellPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 6px 20px rgba(255, 107, 157, 0.6);
            }
        }

        .notif-btn:hover {
            opacity: 1;
            transform: scale(1.15);
            animation: none;
        }

        .notif-btn.has-messages {
            animation: bellShake 1.5s ease-in-out infinite;
        }

        @keyframes bellShake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-8deg); }
            75% { transform: rotate(8deg); }
        }

        /* Notification Badge */
        .notif-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff3838;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(255, 56, 56, 0.5);
            animation: badgePulse 2s ease-in-out infinite;
        }

        @keyframes badgePulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(255, 56, 56, 0.5);
            }
            50% { 
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(255, 56, 56, 0.7);
            }
        }

        /* Messages Container */
        .messages-container {
            position: fixed;
            top: 200px;
            right: 80px;
            width: 260px;
            max-height: 450px;
            display: none;
            flex-direction: column;
            gap: 15px;
            z-index: 99;
            overflow-y: auto;
            overflow-x: visible;
            padding: 15px;
            transform-origin: top right;
            background: transparent;
            border-radius: 20px;
        }

        .messages-container.active {
            display: flex;
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(255, 107, 157, 0.3);
            border-radius: 10px;
        }

        /* Message Bubble */
        .message-bubble {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px 20px 5px 20px;
            padding: 15px 18px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            opacity: 0;
            transform: translateX(80px) scale(0.6);
            animation: slideInMessage 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            max-width: 240px;
            word-wrap: break-word;
            border-left: 3px solid var(--primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: none;
        }

        body.theme-night .message-bubble {
            background: rgba(61, 43, 94, 0.95);
            color: var(--text-dark);
        }

        .message-bubble:hover {
            transform: translateX(0) scale(1.03);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 1);
        }

        body.theme-night .message-bubble:hover {
            background: rgba(71, 53, 104, 1);
        }

        .message-bubble.new-message {
            border-left: 3px solid #00b894;
            background: rgba(232, 248, 245, 0.95);
            animation: slideInMessage 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards,
                       glowPulse 2s ease-in-out infinite;
        }

        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(0, 184, 148, 0.2); }
            50% { box-shadow: 0 4px 20px rgba(0, 184, 148, 0.4); }
        }

        .message-bubble.new-message::after {
            content: 'NEW';
            position: absolute;
            top: -6px;
            right: 15px;
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            font-size: 9px;
            font-weight: 800;
            padding: 3px 10px;
            border-radius: 12px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 184, 148, 0.3);
        }

        .message-bubble::before {
            content: '';
            position: absolute;
            top: 10px;
            right: -8px;
            width: 0;
            height: 0;
            border-left: 10px solid #ffe6f0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }

        @keyframes slideInMessage {
            to {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .message-bubble.closing {
            animation: slideOutMessage 0.3s ease-in forwards;
        }

        @keyframes slideOutMessage {
            to {
                opacity: 0;
                transform: translateX(50px) scale(0.8);
            }
        }

        .message-bubble-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-dark);
            margin: 0;
            white-space: pre-wrap;
        }

        .message-bubble-time {
            font-size: 11px;
            color: var(--text-light);
            margin-top: 8px;
            display: block;
        }

        .message-bubble-icon {
            font-size: 18px;
            margin-bottom: 5px;
            display: block;
        }

        /* Duaa Overlay - Cute Pink Theme */
        .duaa-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .duaa-overlay.active {
            display: flex;
            opacity: 1;
        }

        .duaa-container {
            background: linear-gradient(135deg, #fff5f9 0%, #ffe8f2 50%, #fff0f7 100%);
            border-radius: 30px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                inset 0 0 60px rgba(255, 183, 213, 0.2);
            position: relative;
            transform: scale(0.9);
            transition: transform 0.4s ease;
            border: 3px solid rgba(255, 158, 205, 0.4);
        }

        body.theme-night .duaa-container {
            background: linear-gradient(135deg, #4a3a5e 0%, #3d2b5e 50%, #4a3a5e 100%);
            border: 3px solid rgba(232, 180, 224, 0.4);
        }

        .duaa-overlay.active .duaa-container {
            transform: scale(1);
        }

        .duaa-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 158, 205, 0.2);
            color: #ff7eb8;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .duaa-close:hover {
            background: rgba(255, 158, 205, 0.4);
            transform: rotate(90deg);
        }

        .duaa-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 158, 205, 0.3);
        }

        body.theme-night .duaa-header {
            border-bottom: 2px solid rgba(232, 180, 224, 0.3);
        }

        .duaa-icon {
            font-size: 50px;
            margin-bottom: 15px;
            filter: drop-shadow(0 2px 4px rgba(255, 158, 205, 0.3));
        }

        .duaa-title {
            font-size: 26px;
            font-weight: 700;
            color: #ff7eb8;
            margin-bottom: 10px;
        }

        body.theme-night .duaa-title {
            color: #e8b4e0;
        }

        .duaa-subtitle {
            font-size: 14px;
            color: #b88aa0;
        }

        body.theme-night .duaa-subtitle {
            color: #c9b8d4;
        }

        .duaa-content {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 158, 205, 0.3);
        }

        body.theme-night .duaa-content {
            background: rgba(61, 43, 94, 0.6);
            border: 2px solid rgba(232, 180, 224, 0.3);
        }

        .duaa-text {
            font-size: 18px;
            line-height: 2;
            color: #5a4a5a;
            text-align: center;
            font-family: 'Amiri', serif;
            direction: rtl;
        }

        body.theme-night .duaa-text {
            color: #ffe8f5;
        }

        .duaa-translation {
            font-size: 14px;
            line-height: 1.8;
            color: #8a7a8a;
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 158, 205, 0.3);
            font-style: italic;
        }

        body.theme-night .duaa-translation {
            color: #c9b8d4;
            border-top: 1px solid rgba(232, 180, 224, 0.3);
        }

        .duaa-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .duaa-nav-btn {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 15px;
            background: linear-gradient(135deg, #ffb7d5, #ff9ecd);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 158, 205, 0.4);
        }

        .duaa-nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 158, 205, 0.6);
        }

        .duaa-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .duaa-counter {
            font-size: 14px;
            color: #ff7eb8;
            font-weight: 600;
        }

        body.theme-night .duaa-counter {
            color: #e8b4e0;
        }

        .duaa-empty {
            text-align: center;
            padding: 40px;
            color: #8a7a8a;
        }

        .duaa-empty-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        /* Cute pattern decoration */
        .duaa-pattern {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border-radius: 25px;
            pointer-events: none;
            opacity: 0.08;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 5 L25 15 L35 15 L27 22 L30 32 L20 26 L10 32 L13 22 L5 15 L15 15 Z' fill='none' stroke='%23ff9ecd' stroke-width='1'/%3E%3C/svg%3E");
        }

        /* Mobile responsive */
        @media (max-width: 480px) {
            .messages-container {
                width: calc(100vw - 100px);
                right: 75px;
                left: auto;
                top: 160px;
                padding: 10px;
                background: transparent;
            }

            .message-bubble {
                max-width: 100%;
                animation: slideInMessageMobile 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }

            @keyframes slideInMessageMobile {
                from {
                    opacity: 0;
                    transform: translateX(60px) scale(0.7);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            .duaa-container {
                padding: 25px;
            }

            .duaa-title {
                font-size: 22px;
            }

            .duaa-text {
                font-size: 16px;
            }

            .gift-btn, .duaa-btn, .todo-btn, .notif-btn {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }

            .todo-btn {
                top: 15px;
                left: 15px;
            }

            .gift-btn {
                top: 15px;
                right: 15px;
            }

            .duaa-btn {
                top: 70px;
                right: 15px;
            }

            .notif-btn.position-with-duaa {
                top: 120px;
            }

            .notif-btn.position-no-duaa {
                top: 70px;
            }
        }

        /* To-Do Modal */
        .todo-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .todo-modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .todo-modal {
            background: linear-gradient(135deg, #ffeef8, #fff5f7);
            border-radius: 30px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        body.theme-night .todo-modal {
            background: linear-gradient(135deg, #4a3a5e, #3d2b5e);
        }

        .todo-modal-overlay.active .todo-modal {
            transform: scale(1);
        }

        .todo-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 3px solid var(--primary-light);
            padding-bottom: 15px;
        }

        .todo-modal-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .todo-modal-close {
            background: none;
            border: none;
            font-size: 30px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .todo-modal-close:hover {
            color: var(--primary);
            transform: rotate(90deg);
        }

        /* GPA Display */
        .gpa-container {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: visible;
        }

        body.theme-night .gpa-container {
            background: #3d2b5e;
        }

        .gpa-circle {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 15px;
            overflow: visible;
        }

        .gpa-circle svg {
            transform: rotate(-90deg);
            overflow: visible;
        }

        .gpa-circle-bg {
            fill: none;
            stroke: #f0f0f0;
            stroke-width: 12;
        }

        body.theme-night .gpa-circle-bg {
            stroke: #5a4a6e;
        }

        .gpa-circle-progress {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease, stroke 0.5s ease;
            overflow: visible;
        }

        .gpa-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 36px;
            font-weight: 700;
        }

        .gpa-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .gpa-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 14px;
        }

        .gpa-stat {
            text-align: center;
        }

        .gpa-stat-value {
            font-weight: 700;
            font-size: 20px;
            display: block;
        }

        .gpa-stat-label {
            color: var(--text-light);
            font-size: 12px;
        }

        /* To-Do Input Area */
        .todo-input-container {
            margin-bottom: 25px;
        }

        .todo-date-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
            text-align: center;
        }

        .todo-input-area {
            position: relative;
            margin-bottom: 15px;
        }

        .todo-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 3px solid var(--primary-light);
            border-radius: 15px;
            font-family: inherit;
            font-size: 16px;
            line-height: 2;
            resize: vertical;
            transition: border-color 0.3s ease;
            background: var(--white);
            color: var(--text-dark);
        }

        .todo-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .todo-textarea::placeholder {
            color: #b2bec3;
        }

        .todo-hint {
            font-size: 13px;
            color: var(--text-light);
            margin-top: 8px;
            text-align: center;
        }

        .todo-submit-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 15px;
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .todo-submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4);
        }

        /* To-Do List Display */
        .todo-list-container {
            margin-bottom: 20px;
        }

        .todo-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        body.theme-night .todo-item {
            background: #4a3a5e;
        }

        .todo-item:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateX(5px);
        }

        .todo-item.completed {
            opacity: 0.6;
        }

        .todo-item.completed .todo-item-text {
            text-decoration: line-through;
            color: var(--text-light);
        }

        .todo-checkbox {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .todo-item[dir="rtl"] .todo-checkbox {
            margin-right: 0;
            margin-left: 15px;
        }

        .todo-item-text {
            flex: 1;
            font-size: 16px;
            line-height: 1.5;
            color: var(--text-dark);
        }

        .todo-item-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-light), var(--secondary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            margin-right: 10px;
            color: var(--primary-dark);
        }

        .todo-item[dir="rtl"] .todo-item-number {
            margin-right: 0;
            margin-left: 10px;
        }

        /* Action Buttons */
        .todo-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .todo-action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 15px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .todo-new-btn {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .todo-new-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.4);
        }

        .todo-edit-btn {
            background: linear-gradient(135deg, #ffa500, #ff8c00);
            color: white;
        }

        .todo-edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 165, 0, 0.4);
        }

        .todo-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .todo-empty-state-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        /* Edit Mode */
        .todo-edit-area {
            display: none;
        }

        .todo-edit-area.active {
            display: block;
        }

        .todo-view-area {
            display: block;
        }

        .todo-view-area.hidden {
            display: none;
        }

        /* Gift Video Overlay */
        .gift-video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .gift-video-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .gift-video-container {
            position: relative;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            overflow: hidden;
            border: 5px solid var(--accent);
            box-shadow: 0 0 50px rgba(255, 217, 61, 0.8);
            transform: scale(0);
            animation: giftVideoEnter 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes giftVideoEnter {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .gift-video-container.exit {
            animation: giftVideoExit 0.5s ease-in forwards;
        }

        @keyframes giftVideoExit {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: scale(0) rotate(180deg);
                opacity: 0;
            }
        }

        .gift-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gift-play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .gift-play-button:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .gift-play-button.show {
            display: flex;
        }

        /* Main Container */
        .main-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 42px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 18px;
            color: var(--text-light);
        }

        /* Character Section */
        .character-section {
            margin-bottom: 30px;
            position: relative;
        }

        .character-container {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            overflow: hidden;
            border: 5px solid var(--white);
            box-shadow: 0 15px 40px var(--shadow);
            background: linear-gradient(135deg, var(--primary-light), var(--secondary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .character-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .character-placeholder {
            font-size: 80px;
        }

        .character-glow {
            position: absolute;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary-light) 0%, transparent 70%);
            z-index: -1;
            animation: pulse 3s infinite ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* Progress Section */
        .progress-section {
            width: 100%;
            max-width: 800px;
            background: var(--white);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 15px var(--shadow-soft);
            text-align: center;
            margin-bottom: 20px;
        }

        .progress-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 15px;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            margin-bottom: 10px;
        }

        body.theme-night .progress-bar-container {
            background: #4a3a5e;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-dark), var(--primary-light));
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-weight: 700;
            font-size: 14px;
        }

        .progress-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-light);
        }

        /* Days Container */
        .days-container {
            width: 100%;
            max-width: 900px;
            max-height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            margin-bottom: 30px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-light) transparent;
        }

        .days-container::-webkit-scrollbar {
            width: 8px;
        }

        .days-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .days-container::-webkit-scrollbar-thumb {
            background: var(--primary-light);
            border-radius: 10px;
        }

        .days-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }

        /* Day Card */
        .day-card {
            background: var(--white);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow-soft);
            border: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .day-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-light), var(--secondary-light));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }

        .day-card:hover::before {
            opacity: 0.15;
        }

        .day-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px var(--shadow);
        }

        .day-card.unlocked {
            background: linear-gradient(135deg, rgba(255, 158, 205, 0.1), rgba(168, 216, 234, 0.1));
            border-color: var(--primary-light);
        }

        .day-card.unlocked:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(255, 158, 205, 0.15), rgba(168, 216, 234, 0.15));
        }

        .day-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        body.theme-night .day-card.locked {
            background: #2d1b4e;
        }

        .day-card.locked:hover {
            transform: none;
            box-shadow: 0 4px 15px var(--shadow-soft);
        }

        .day-content {
            position: relative;
            z-index: 1;
        }

        .day-number {
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .day-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .day-status {
            font-size: 28px;
        }

        .day-card.locked .day-number,
        .day-card.locked .day-label {
            opacity: 0.5;
        }

        .day-btn {
            padding: 15px 30px;
            border-radius: 25px;
            border: none;
            background: var(--white);
            color: var(--primary-dark);
            font-family: inherit;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 5px 20px var(--shadow-soft);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .day-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .day-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px var(--shadow);
            color: white;
        }

        .day-btn:hover::before {
            opacity: 1;
        }

        .day-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        /* Message Display */
        .message-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: var(--white);
            border-radius: 25px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .message-display.active {
            display: block;
            animation: smoothFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes smoothFadeIn {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0);
            backdrop-filter: blur(0px);
            display: none;
            z-index: 999;
            transition: all 0.4s ease;
        }

        .message-overlay.active {
            display: block;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-light);
        }

        .message-day-badge {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
        }

        .progress-toggle-btn {
            margin-left: 10px;
            padding: 8px 15px;
            border: 2px solid var(--accent);
            border-radius: 20px;
            background: var(--accent-light);
            color: var(--text-dark);
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .progress-toggle-btn:hover {
            background: var(--accent);
            transform: scale(1.05);
        }

        .progress-toggle-btn.active {
            background: var(--accent);
            box-shadow: 0 0 15px rgba(255, 217, 61, 0.5);
        }

        /* Sticky Note Container */
        .sticky-note-container {
            display: none;
        }

        .sticky-note-container.active {
            display: block;
        }

        .sticky-note {
            background: linear-gradient(135deg, #fffacd 0%, #ffeaa7 100%);
            border-radius: 3px;
            padding: 30px 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            position: relative;
            font-family: 'Quicksand', cursive;
            min-height: 300px;
            border-top: 50px solid #f9ca24;
        }

        .sticky-note::before {
            content: '';
            position: absolute;
            top: -40px;
            right: 20px;
            font-size: 30px;
            transform: rotate(15deg);
        }

        .sticky-note-title {
            font-size: 20px;
            font-weight: 700;
            color: #e17055;
            margin-bottom: 15px;
            text-align: center;
        }

        .sticky-note-subtitle {
            font-size: 14px;
            color: #636e72;
            margin-bottom: 20px;
            text-align: center;
        }

        .sticky-note-textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: none;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            font-family: 'Quicksand', sans-serif;
            font-size: 16px;
            line-height: 1.8;
            resize: vertical;
            color: var(--text-dark);
        }

        .sticky-note-textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.8);
        }

        .sticky-note-textarea::placeholder {
            color: #b2bec3;
        }

        .sticky-note-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .sticky-note-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .sticky-note-save {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .sticky-note-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 184, 148, 0.4);
        }

        .sticky-note-cancel {
            background: #dfe6e9;
            color: var(--text-dark);
        }

        .sticky-note-cancel:hover {
            background: #b2bec3;
        }

        /* Progress view */
        .progress-note-view {
            display: none;
        }

        .progress-note-view.active {
            display: block;
        }

        .progress-note-content {
            background: linear-gradient(135deg, #fffacd 0%, #ffeaa7 100%);
            border-radius: 3px;
            padding: 30px 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            position: relative;
            font-family: 'Quicksand', cursive;
            min-height: 200px;
            border-top: 50px solid #f9ca24;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 16px;
            color: var(--text-dark);
        }

        .progress-note-content::before {
            content: '';
            position: absolute;
            top: -40px;
            right: 20px;
            font-size: 30px;
            transform: rotate(15deg);
        }

        .progress-note-edit-btn {
            margin-top: 15px;
            padding: 10px 25px;
            border: none;
            border-radius: 15px;
            background: linear-gradient(135deg, #ffa500, #ff8c00);
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .progress-note-edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 165, 0, 0.4);
        }

        /* Progress indicator on day cards */
        .day-progress-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .message-parts-container {
            display: block;
        }

        .message-parts-container.hidden {
            display: none;
        }

        .message-close {
            margin-left: auto;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .message-close:hover {
            color: var(--primary-dark);
        }

        .message-content {
            font-size: 18px;
            line-height: 1.8;
            color: var(--text-dark);
            margin-bottom: 20px;
            min-height: 100px;
        }

        .message-image {
            width: 100%;
            max-height: 250px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .message-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .part-indicator {
            font-size: 14px;
            color: var(--text-light);
        }

        .next-btn {
            padding: 12px 30px;
            border-radius: 25px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            font-family: inherit;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .next-btn:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px var(--shadow);
        }

        .next-btn:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--primary-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        /* Voice Message Player */
        .voice-player {
            background: linear-gradient(135deg, var(--primary-light), var(--secondary-light));
            border-radius: 25px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            box-shadow: 0 4px 15px var(--shadow);
            border: 2px solid var(--primary);
        }

        .voice-play-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .voice-play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .voice-play-btn:active {
            transform: scale(0.95);
        }

        .voice-progress-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .voice-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .voice-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-dark), var(--primary));
            border-radius: 10px;
            width: 0%;
            transition: width 0.1s linear;
            position: relative;
        }

        .voice-progress-fill::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .voice-time {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-dark);
            font-weight: 600;
        }

        /* Footer */
        .footer {
            margin-top: 40px;
            text-align: center;
            color: var(--text-light);
            font-size: 14px;
        }

        .footer-heart {
            color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 32px;
            }

            .character-container {
                width: 180px;
                height: 180px;
            }

            .days-container {
                max-height: 400px;
                padding: 15px;
            }

            .days-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 15px;
            }

            .day-card {
                padding: 20px;
            }

            .day-number {
                font-size: 36px;
            }

            .day-label {
                font-size: 14px;
            }

            .day-status {
                font-size: 24px;
            }

            .progress-section {
                padding: 20px;
            }

            .progress-title {
                font-size: 16px;
            }

            .day-btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            .message-display {
                width: 95%;
                padding: 20px;
                max-height: 80vh;
            }

            .message-content {
                font-size: 16px;
            }

            .gift-video-container {
                width: 200px;
                height: 200px;
            }

            .gpa-circle {
                width: 120px;
                height: 120px;
                overflow: visible;
            }

            .gpa-circle svg {
                width: 120px;
                height: 120px;
                overflow: visible;
            }

            .gpa-text {
                font-size: 28px;
            }

            .todo-actions {
                flex-direction: column;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .days-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }

        @media (min-width: 1025px) {
            .days-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Floating Hearts Background (Default Theme) -->
    <div class="hearts-container" id="heartsContainer"></div>

    <!-- Magical Night Theme Elements -->
    <div class="night-magic-container" id="nightMagicContainer"></div>

    <!-- Fireworks Canvas -->
    <canvas class="fireworks-canvas" id="fireworksCanvas"></canvas>

    <!-- Welcome Overlay -->
    <div class="welcome-overlay" id="welcomeOverlay">
        <div class="welcome-box">
            <button class="welcome-close" onclick="closeWelcome()">&times;</button>
            <div class="welcome-icon" id="welcomeIcon"></div>
            <h2 class="welcome-title" id="welcomeTitle">Hello Aiko!</h2>
            <p class="welcome-text" id="welcomeText">Welcome to your special support space! I'm here to cheer you on every day until your exam. You've got this! </p>
        </div>
    </div>

    <!-- To-Do List Button - Top Left -->
    <button class="todo-btn" onclick="openTodoModal()" title="To-Do List & GPA"></button>

    <!-- Study Timer Button - Below Todo -->
    <button class="study-timer-btn" onclick="openStudyTimer()" title="Study Timer"></button>
    
    <!-- Gift Button - Top Right -->
    <button class="gift-btn" onclick="playGiftVideo()" title="Special Gift" id="giftBtn"></button>

    <!-- Duaa Button - Below Gift -->
    <button class="duaa-btn" onclick="openDuaaOverlay()" title="Duaa & Prayers" id="duaaBtn"></button>

    <!-- Notification Bell Button - Dynamic Position -->
    <button class="notif-btn" onclick="toggleMessages()" title="Messages" id="notifBtn">
        
        <span class="notif-badge" id="notifBadge" style="display: none;">0</span>
    </button>

    <!-- Messages Container -->
    <div class="messages-container" id="messagesContainer"></div>

    <!-- Duaa Overlay -->
    <div class="duaa-overlay" id="duaaOverlay" onclick="closeDuaaOverlay(event)">
        <div class="duaa-container" onclick="event.stopPropagation()">
            <div class="duaa-pattern"></div>
            <button class="duaa-close" onclick="closeDuaaOverlay()">&times;</button>
            <div class="duaa-header">
                <div class="duaa-icon"></div>
                <h2 class="duaa-title">Duaa & Prayers</h2>
                <p class="duaa-subtitle">May Allah bless you always</p>
            </div>
            <div id="duaaContent">
                <div class="duaa-empty">
                    <div class="duaa-empty-icon"></div>
                    <p>No duaa added yet</p>
                </div>
            </div>
        </div>
    </div>

    <!-- To-Do Modal -->
    <div class="todo-modal-overlay" id="todoModalOverlay" onclick="closeTodoModal()">
        <div class="todo-modal" onclick="event.stopPropagation()">
            <div class="todo-modal-header">
                <h2 class="todo-modal-title"> Study Tracker & GPA</h2>
                <button class="todo-modal-close" onclick="closeTodoModal()">&times;</button>
            </div>

            <!-- GPA Display -->
            <div class="gpa-container" id="gpaContainer">
                <div class="gpa-label">Your Study GPA</div>
                <div class="gpa-circle">
                    <svg width="150" height="150" viewBox="0 0 150 150" style="overflow: visible;">
                        <circle class="gpa-circle-bg" cx="75" cy="75" r="65"></circle>
                        <circle class="gpa-circle-progress" id="gpaCircle" cx="75" cy="75" r="65" 
                                stroke-dasharray="408.4" stroke-dashoffset="408.4"></circle>
                    </svg>
                    <div class="gpa-text" id="gpaText">0.0</div>
                </div>
                <div class="gpa-stats">
                    <div class="gpa-stat">
                        <span class="gpa-stat-value" id="totalTasks">0</span>
                        <span class="gpa-stat-label">Total Tasks</span>
                    </div>
                    <div class="gpa-stat">
                        <span class="gpa-stat-value" id="completedTasks" style="color: #00b894;">0</span>
                        <span class="gpa-stat-label">Completed</span>
                    </div>
                    <div class="gpa-stat">
                        <span class="gpa-stat-value" id="incompleteTasks" style="color: #ff7675;">0</span>
                        <span class="gpa-stat-label">Remaining</span>
                    </div>
                </div>
            </div>

            <!-- Input Area (for new/edit) -->
            <div class="todo-input-container todo-edit-area" id="todoEditArea">
                <div class="todo-date-label" id="todoDateLabel">Today's Study Goals</div>
                <div class="todo-input-area">
                    <textarea 
                        class="todo-textarea" 
                        id="todoTextarea" 
                        placeholder="Write each task on a new line... 

Example:
- Review Chapter 5
- Practice 20 problems
- Memorize vocabulary
- Watch lecture video"
                    ></textarea>
                    <div class="todo-hint"> Write each task on a new line. Works in English & Arabic!</div>
                </div>
                <button class="todo-submit-btn" onclick="submitTodoList()"> Save To-Do List</button>
            </div>

            <!-- View Area (for viewing/checking) -->
            <div class="todo-view-area" id="todoViewArea">
                <div class="todo-date-label" id="todoViewDateLabel"></div>
                <div class="todo-list-container" id="todoListContainer">
                    <div class="todo-empty-state">
                        <div class="todo-empty-state-icon"></div>
                        <p>No to-do list yet!</p>
                        <p style="font-size: 14px;">Create your first study plan above </p>
                    </div>
                </div>
                <div class="todo-actions">
                    <button class="todo-action-btn todo-edit-btn" onclick="editTodoList()"> Edit List</button>
                    <button class="todo-action-btn todo-new-btn" onclick="startNewTodoList()"> New Day</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gift Video Overlay -->
    <div class="gift-video-overlay" id="giftVideoOverlay" onclick="closeGiftVideo()">
        <div class="gift-video-container" id="giftVideoContainer" onclick="event.stopPropagation()">
            <video class="gift-video" id="giftVideo" playsinline muted></video>
            <div class="gift-play-button" id="giftPlayButton" onclick="manualPlayGiftVideo()">
                <span style="font-size: 60px;"></span>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <header class="header">
            <h1>For Aiko </h1>
            <p>Your daily dose of encouragement!</p>
        </header>

        <!-- Character Section -->
        <div class="character-section">
            <div class="character-glow"></div>
            <div class="character-container" id="characterContainer">
                <span class="character-placeholder"></span>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection" style="display: none;">
            <div class="progress-title">Your Progress</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBar">0%</div>
            </div>
            <div class="progress-text" id="progressText">0 of 0 days completed</div>
        </div>

        <!-- Days Container -->
        <div class="days-container" id="daysContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading your days...</p>
            </div>
        </div>

        <!-- Message Overlay -->
        <div class="message-overlay" id="messageOverlay" onclick="closeMessage()"></div>

        <!-- Message Display -->
        <div class="message-display" id="messageDisplay">
            <div class="message-header">
                <span class="message-day-badge" id="messageDayBadge">Day 1</span>
                <button class="progress-toggle-btn" id="progressToggleBtn" onclick="toggleProgress()"> Add Progress</button>
                <button class="message-close" onclick="closeMessage()">&times;</button>
            </div>
            
            <!-- Message Parts Container -->
            <div class="message-parts-container" id="messagePartsContainer">
                <img class="message-image" id="messageImage" style="display: none;">
                <div id="messageVoiceContainer" style="display: none;"></div>
                <div class="message-content" id="messageContent"></div>
                <div class="message-nav">
                    <span class="part-indicator" id="partIndicator">Part 1 of 3</span>
                    <button class="next-btn" id="nextBtn" onclick="nextPart()">
                        Next <span></span>
                    </button>
                </div>
            </div>

            <!-- Sticky Note Container (for editing) -->
            <div class="sticky-note-container" id="stickyNoteContainer">
                <div class="sticky-note">
                    <div class="sticky-note-title"> Today's Progress </div>
                    <div class="sticky-note-subtitle">What did you study? What did you accomplish?</div>
                    <textarea 
                        class="sticky-note-textarea" 
                        id="progressTextarea" 
                        placeholder=" Write down what you studied today...

 Topics covered:

 What you accomplished:

 How you feel:"
                    ></textarea>
                    <div class="sticky-note-buttons">
                        <button class="sticky-note-btn sticky-note-save" onclick="saveProgress()"> Save</button>
                        <button class="sticky-note-btn sticky-note-cancel" onclick="cancelProgress()"> Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Progress Note View (for reading) -->
            <div class="progress-note-view" id="progressNoteView">
                <div class="progress-note-content" id="progressNoteContent"></div>
                <button class="progress-note-edit-btn" onclick="editProgress()"> Edit Progress</button>
            </div>
        </div>

        <footer class="footer">
            <p>Made with <span class="footer-heart"></span> for Aiko | You've got this!</p>
        </footer>
    </div>

    <script>

        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://ferapozpiqskfflsbizy.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GmR9-CM1hvtC7kxRCI_KRA_bxxv1_nl';
        
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (e) {
            console.error('Supabase init error:', e);
        }

        // ============================================
        // STATE
        // ============================================
        let currentDay = null;
        let currentDayNumber = null;
        let currentPart = 0;
        let dayData = null;
        let allDays = [];
        let welcomeSettings = {};
        let totalDays = 15;
        let currentProgressNote = null;
        let dayProgressNotes = new Map();
        let currentTodoList = null;
        let allTodoLists = [];
        let allMessages = [];
        let messagesOpen = false;
        let allDuaas = [];
        let currentDuaaIndex = 0;
        let giftVideoUrl = '';
        const STORAGE_BUCKET = 'images';

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            createFloatingHearts();
            createNightMagic();
            loadData();
        });

                // ============================================
        // STUDY TIMER BUTTON - OPEN CLOCK PAGE
        // ============================================
        function openStudyTimer() {
            window.open('clock.html', '_blank');
        }

        function createFloatingHearts() {
            const container = document.getElementById('heartsContainer');
            const hearts = ['', '', '', '', '', '', '', ''];
            
            for (let i = 0; i < 20; i++) {
                const heart = document.createElement('div');
                heart.className = 'heart';
                heart.textContent = hearts[Math.floor(Math.random() * hearts.length)];
                heart.style.left = Math.random() * 100 + '%';
                heart.style.animationDelay = Math.random() * 15 + 's';
                heart.style.animationDuration = (10 + Math.random() * 10) + 's';
                container.appendChild(heart);
            }
        }

        function createNightMagic() {
            const container = document.getElementById('nightMagicContainer');
            
            // Twinkling stars
            for (let i = 0; i < 60; i++) {
                const star = document.createElement('div');
                star.className = 'magic-star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                star.style.animationDuration = (1.5 + Math.random() * 2) + 's';
                container.appendChild(star);
            }
            
            // Shooting stars
            for (let i = 0; i < 5; i++) {
                const shootingStar = document.createElement('div');
                shootingStar.className = 'shooting-star';
                shootingStar.style.top = Math.random() * 50 + '%';
                shootingStar.style.left = Math.random() * 50 + '%';
                shootingStar.style.animationDelay = (i * 2 + Math.random() * 2) + 's';
                shootingStar.style.animationDuration = (2.5 + Math.random() * 1.5) + 's';
                container.appendChild(shootingStar);
            }
            
            // Floating moons
            const moons = ['',''];
            for (let i = 0; i < 8; i++) {
                const moon = document.createElement('div');
                moon.className = 'floating-moon';
                moon.textContent = moons[Math.floor(Math.random() * moons.length)];
                moon.style.left = Math.random() * 100 + '%';
                moon.style.top = Math.random() * 100 + '%';
                moon.style.animationDelay = Math.random() * 20 + 's';
                moon.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(moon);
            }
            
            // Sparkles
            for (let i = 0; i < 30; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * 100 + '%';
                sparkle.style.top = Math.random() * 100 + '%';
                sparkle.style.animationDelay = Math.random() * 4 + 's';
                sparkle.style.animationDuration = (3 + Math.random() * 2) + 's';
                container.appendChild(sparkle);
            }
        }

        // ============================================
        // THEME FUNCTIONS
        // ============================================
        async function loadTheme() {
            try {
                const { data, error } = await supabase
                    .from('themes')
                    .select('*')
                    .eq('id', 1)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading theme:', error);
                    return;
                }

                if (data) {
                    applyTheme(data.theme_name);
                }
            } catch (error) {
                console.error('Error loading theme:', error);
            }
        }

        function applyTheme(themeName) {
            document.body.classList.remove('theme-night');
            
            if (themeName === 'night') {
                document.body.classList.add('theme-night');
            }
            
            console.log('Theme applied:', themeName);
        }

        // ============================================
        // THEME AUTOMATION (Independent from admin panel)
        // ============================================
        let automationSettings = {
            enabled: false,
            nightTime: '19:00',
            defaultTime: '06:00'
        };

        // Load automation settings from database
        async function loadAutomationSettings() {
            try {
                const { data, error } = await supabase
                    .from('theme_automation')
                    .select('*')
                    .eq('id', 1)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading automation settings:', error);
                    return;
                }

                if (data) {
                    automationSettings = {
                        enabled: data.enabled || false,
                        nightTime: data.night_time || '19:00',
                        defaultTime: data.default_time || '06:00'
                    };
                    console.log('Automation settings loaded:', automationSettings);
                }
            } catch (error) {
                console.error('Error loading automation settings:', error);
            }
        }

        // Determine which theme should be active based on Lebanon time
        function getAutomatedTheme() {
            const now = new Date();
            // Get current time in Lebanon (Asia/Beirut)
            const lebanonTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Beirut' }));
            const currentMinutes = lebanonTime.getHours() * 60 + lebanonTime.getMinutes();

            const [nightH, nightM] = automationSettings.nightTime.split(':').map(Number);
            const [defaultH, defaultM] = automationSettings.defaultTime.split(':').map(Number);
            const nightMinutes = nightH * 60 + nightM;
            const defaultMinutes = defaultH * 60 + defaultM;

            // Handle schedule that crosses midnight (e.g., night=19:00, default=06:00)
            if (nightMinutes > defaultMinutes) {
                // Night is active from nightMinutes to midnight AND midnight to defaultMinutes
                if (currentMinutes >= nightMinutes || currentMinutes < defaultMinutes) {
                    return 'night';
                }
                return 'default';
            } else {
                // Night is active from nightMinutes to defaultMinutes (same day)
                if (currentMinutes >= nightMinutes && currentMinutes < defaultMinutes) {
                    return 'night';
                }
                return 'default';
            }
        }

        // Apply the correct theme based on automation settings
        async function applyAutomatedTheme() {
            if (!automationSettings.enabled) {
                // If automation is off, just load the theme from database
                await loadThemeFromDB();
                return;
            }

            const correctTheme = getAutomatedTheme();
            applyTheme(correctTheme);
            console.log('Automated theme applied:', correctTheme, '- Lebanon time check');
        }

        // Load theme from database (fallback when automation is off)
        async function loadThemeFromDB() {
            try {
                const { data, error } = await supabase
                    .from('themes')
                    .select('theme_name')
                    .eq('id', 1)
                    .single();

                if (data && data.theme_name) {
                    applyTheme(data.theme_name);
                }
            } catch (error) {
                console.error('Error loading theme from DB:', error);
            }
        }

        // Start periodic theme checking
        function startThemeAutomation() {
            // Check theme every 60 seconds
            setInterval(async () => {
                if (automationSettings.enabled) {
                    const correctTheme = getAutomatedTheme();
                    const isCurrentlyNight = document.body.classList.contains('theme-night');
                    const currentTheme = isCurrentlyNight ? 'night' : 'default';

                    if (correctTheme !== currentTheme) {
                        console.log(`Auto-switching theme: ${currentTheme} -> ${correctTheme}`);
                        applyTheme(correctTheme);
                    }
                }
            }, 60000);

            console.log('Theme automation started - checking every 60 seconds');
        }

        // ============================================
        // FIREWORKS ANIMATION
        // ============================================
        
        class Firework {
            constructor(canvas, startX, startY, targetX, targetY, color) {
                this.canvas = canvas;
                this.x = startX;
                this.y = startY;
                this.startX = startX;
                this.startY = startY;
                this.targetX = targetX;
                this.targetY = targetY;
                this.distanceToTarget = Math.sqrt(Math.pow(targetX - startX, 2) + Math.pow(targetY - startY, 2));
                this.distanceTraveled = 0;
                this.coordinates = [];
                this.coordinateCount = 3;
                while (this.coordinateCount--) {
                    this.coordinates.push([this.x, this.y]);
                }
                this.angle = Math.atan2(targetY - startY, targetX - startX);
                this.speed = 2;
                this.acceleration = 1.05;
                this.brightness = Math.random() * 50 + 50;
                this.targetRadius = 1;
                this.color = color;
            }

            update(index) {
                this.coordinates.pop();
                this.coordinates.unshift([this.x, this.y]);
                
                if (this.targetRadius < 8) {
                    this.targetRadius += 0.3;
                } else {
                    this.targetRadius = 1;
                }
                
                this.speed *= this.acceleration;
                
                const vx = Math.cos(this.angle) * this.speed;
                const vy = Math.sin(this.angle) * this.speed;
                
                this.distanceTraveled = Math.sqrt(Math.pow(this.x - this.startX, 2) + Math.pow(this.y - this.startY, 2));
                
                if (this.distanceTraveled >= this.distanceToTarget) {
                    createParticles(this.canvas, this.targetX, this.targetY, this.color);
                    fireworks.splice(index, 1);
                } else {
                    this.x += vx;
                    this.y += vy;
                }
            }

            draw(ctx) {
                ctx.beginPath();
                ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], 
                          this.coordinates[this.coordinates.length - 1][1]);
                ctx.lineTo(this.x, this.y);
                ctx.strokeStyle = `hsl(${this.color}, 100%, ${this.brightness}%)`;
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.beginPath();
                ctx.arc(this.targetX, this.targetY, this.targetRadius, 0, Math.PI * 2);
                ctx.strokeStyle = `hsl(${this.color}, 100%, ${this.brightness}%)`;
                ctx.stroke();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.coordinates = [];
                this.coordinateCount = 5;
                while (this.coordinateCount--) {
                    this.coordinates.push([this.x, this.y]);
                }
                this.angle = Math.random() * Math.PI * 2;
                this.speed = Math.random() * 10 + 1;
                this.friction = 0.95;
                this.gravity = 1;
                this.hue = color;
                this.brightness = Math.random() * 50 + 50;
                this.alpha = 1;
                this.decay = Math.random() * 0.03 + 0.015;
            }

            update(index) {
                this.coordinates.pop();
                this.coordinates.unshift([this.x, this.y]);
                this.speed *= this.friction;
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed + this.gravity;
                this.alpha -= this.decay;
                
                if (this.alpha <= this.decay) {
                    particles.splice(index, 1);
                }
            }

            draw(ctx) {
                ctx.beginPath();
                ctx.moveTo(this.coordinates[this.coordinates.length - 1][0], 
                          this.coordinates[this.coordinates.length - 1][1]);
                ctx.lineTo(this.x, this.y);
                ctx.strokeStyle = `hsla(${this.hue}, 100%, ${this.brightness}%, ${this.alpha})`;
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        let fireworks = [];
        let particles = [];
        let fireworksCanvas;
        let fireworksCtx;
        let fireworksAnimationFrame;

        function createParticles(canvas, x, y, color) {
            let particleCount = 60;
            while (particleCount--) {
                particles.push(new Particle(x, y, color));
            }
        }

        function launchFirework(canvas) {
            const startX = canvas.width / 2;
            const startY = canvas.height;
            const targetX = Math.random() * (canvas.width - 200) + 100;
            const targetY = Math.random() * (canvas.height / 2) + 50;
            const color = Math.random() * 360;
            
            fireworks.push(new Firework(canvas, startX, startY, targetX, targetY, color));
        }

        function animateFireworks() {
            if (!fireworksCanvas || !fireworksCtx) return;
            
            fireworksAnimationFrame = requestAnimationFrame(animateFireworks);
            
            fireworksCtx.globalCompositeOperation = 'destination-out';
            fireworksCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            fireworksCtx.fillRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
            
            fireworksCtx.globalCompositeOperation = 'lighter';
            
            let i = fireworks.length;
            while (i--) {
                fireworks[i].draw(fireworksCtx);
                fireworks[i].update(i);
            }
            
            let j = particles.length;
            while (j--) {
                particles[j].draw(fireworksCtx);
                particles[j].update(j);
            }
            
            if (Math.random() < 0.08) {
                launchFirework(fireworksCanvas);
            }
        }

        function startFireworks() {
            fireworksCanvas = document.getElementById('fireworksCanvas');
            if (!fireworksCanvas) return;
            
            fireworksCanvas.width = window.innerWidth;
            fireworksCanvas.height = window.innerHeight;
            fireworksCtx = fireworksCanvas.getContext('2d');
            
            fireworksCanvas.classList.add('active');
            
            for (let i = 0; i < 3; i++) {
                setTimeout(() => launchFirework(fireworksCanvas), i * 200);
            }
            
            animateFireworks();
        }

        function stopFireworks() {
            const canvas = document.getElementById('fireworksCanvas');
            if (canvas) {
                canvas.classList.remove('active');
            }
            if (fireworksAnimationFrame) {
                cancelAnimationFrame(fireworksAnimationFrame);
            }
            fireworks = [];
            particles = [];
        }

        function checkAndTriggerFireworks() {
            if (allDays.length === totalDays && totalDays > 0) {
                startFireworks();
            } else {
                stopFireworks();
            }
        }

        window.addEventListener('resize', () => {
            if (fireworksCanvas && fireworksCanvas.classList.contains('active')) {
                fireworksCanvas.width = window.innerWidth;
                fireworksCanvas.height = window.innerHeight;
            }
        });

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadData() {
            try {
                await loadSettings();
                await loadAutomationSettings();
                await applyAutomatedTheme();
                startThemeAutomation();
                await loadGiftVideo();
                await loadDuaas();

                const { data: welcomeData } = await supabase
                    .from('welcome_settings')
                    .select('*')
                    .single();
                
                if (welcomeData) {
                    welcomeSettings = welcomeData;
                    applyWelcomeSettings();
                }

                const { data: charData } = await supabase
                    .from('character')
                    .select('*')
                    .single();
                
                if (charData && charData.image_url) {
                    document.getElementById('characterContainer').innerHTML = 
                        `<img src="${charData.image_url}" alt="Character">`;
                }

                await loadDays();
                await loadAllProgressNotes();
                await loadAllTodos();
                await loadMessages();

            } catch (error) {
                console.error('Error loading data:', error);
                showDemoMode();
            }
        }

        async function loadSettings() {
            try {
                const { data, error } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('key', 'total_days')
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading settings:', error);
                }

                if (data && data.value) {
                    totalDays = parseInt(data.value);
                } else {
                    await supabase.from('settings').insert({ key: 'total_days', value: '15' });
                    totalDays = 15;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                totalDays = 15;
            }
        }

        async function loadGiftVideo() {
            try {
                const { data, error } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('key', 'gift_video_url')
                    .single();

                if (data && data.value) {
                    giftVideoUrl = data.value;
                    document.getElementById('giftBtn').classList.add('visible');
                }
            } catch (error) {
                console.error('Error loading gift video:', error);
            }
        }

        async function loadDuaas() {
            try {
                const { data, error } = await supabase
                    .from('duaas')
                    .select('*')
                    .order('order_index');

                if (error) throw error;

                allDuaas = data || [];
                updateButtonPositions();
            } catch (error) {
                console.error('Error loading duaas:', error);
            }
        }

        function updateButtonPositions() {
            const duaaBtn = document.getElementById('duaaBtn');
            const notifBtn = document.getElementById('notifBtn');
            
            // Show duaa button if there are duaas
            if (allDuaas.length > 0) {
                duaaBtn.classList.add('visible');
                notifBtn.classList.remove('position-no-duaa');
                notifBtn.classList.add('position-with-duaa');
            } else {
                duaaBtn.classList.remove('visible');
                notifBtn.classList.remove('position-with-duaa');
                notifBtn.classList.add('position-no-duaa');
            }
        }

        function applyWelcomeSettings() {
            if (!welcomeSettings) return;
            
            if (welcomeSettings.icon) {
                document.getElementById('welcomeIcon').textContent = welcomeSettings.icon;
            }
            if (welcomeSettings.title) {
                document.getElementById('welcomeTitle').textContent = welcomeSettings.title;
            }
            if (welcomeSettings.message) {
                document.getElementById('welcomeText').textContent = welcomeSettings.message;
            }
            
            if (!welcomeSettings.hidden) {
                setTimeout(() => {
                    document.getElementById('welcomeOverlay').classList.add('active');
                }, 500);
            }
        }

        function showDemoMode() {
            document.getElementById('daysContainer').innerHTML = `
                <button class="day-btn" onclick="showDemoDay(1)">Day 1</button>
                <button class="day-btn" onclick="showDemoDay(2)">Day 2</button>
                <button class="day-btn" onclick="showDemoDay(3)">Day 3</button>
            `;
        }

        function showDemoDay(day) {
            const demoMessages = {
                1: {
                    parts: [
                        { text: "Hello Aiko! Today is the first day of you reading and using this website. I'm so proud of you for starting this journey! ", image_url: null },
                        { text: "I made this website to support you during your study time. Whenever you feel overwhelmed, just come here and remember that you have someone cheering for you! ", image_url: null },
                        { text: "Make sure you open it daily for your dose of encouragement. You've got this! ", image_url: null }
                    ]
                },
                2: {
                    parts: [
                        { text: "Day 2! You're doing amazing, Aiko! Keep up the great work! ", image_url: null },
                        { text: "Remember to take breaks and breathe. Your mental health is just as important as your studies. ", image_url: null }
                    ]
                },
                3: {
                    parts: [
                        { text: "Day 3 already! See how fast time flies when you're focused? You're making progress every single day! ", image_url: null },
                        { text: "Believe in yourself as much as I believe in you. You're capable of amazing things! ", image_url: null },
                        { text: "Keep going, Aiko! The finish line is getting closer! ", image_url: null }
                    ]
                }
            };
            
            dayData = demoMessages[day];
            currentDay = day;
            currentPart = 0;
            showMessage();
        }

        async function loadDays() {
            try {
                const { data: daysData, error: daysError } = await supabase
                    .from('days')
                    .select('*')
                    .order('day_number');

                if (daysError) throw daysError;

                allDays = [];
                for (const day of (daysData || [])) {
                    const { count } = await supabase
                        .from('day_parts')
                        .select('*', { count: 'exact', head: true })
                        .eq('day_id', day.id);
                    
                    allDays.push({
                        ...day,
                        day_parts: new Array(count || 0)
                    });
                }

                renderDays();
            } catch (error) {
                console.error('Error loading days:', error);
            }
        }

        function renderDays() {
            const container = document.getElementById('daysContainer');
            const progressSection = document.getElementById('progressSection');
            
            progressSection.style.display = 'block';
            updateProgress();
            
            const grid = document.createElement('div');
            grid.className = 'days-grid';
            
            for (let i = 1; i <= totalDays; i++) {
                const dayData = allDays.find(d => d.day_number === i);
                const isUnlocked = dayData !== undefined;
                const hasProgress = dayProgressNotes.has(i);
                
                const card = document.createElement('div');
                card.className = `day-card ${isUnlocked ? 'unlocked' : 'locked'}`;
                
                if (isUnlocked) {
                    card.onclick = () => openDay(dayData.id, dayData.day_number);
                }
                
                card.innerHTML = `
                    <div class="day-content">
                        ${hasProgress ? '<div class="day-progress-indicator"></div>' : ''}
                        <div class="day-number">${i}</div>
                        <div class="day-label">Day ${i}</div>
                        <div class="day-status">
                            ${isUnlocked ? '' : ''}
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            }
            
            container.innerHTML = '';
            container.appendChild(grid);
            
            checkAndTriggerFireworks();
        }

        function updateProgress() {
            const createdDays = allDays.length;
            const percentage = totalDays > 0 ? Math.round((createdDays / totalDays) * 100) : 0;

            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressBar').textContent = percentage + '%';
            document.getElementById('progressText').textContent = `${createdDays} of ${totalDays} days created`;
        }

        // ============================================
        // GIFT VIDEO FUNCTIONS
        // ============================================
        function playGiftVideo() {
            if (!giftVideoUrl) return;

            const overlay = document.getElementById('giftVideoOverlay');
            const container = document.getElementById('giftVideoContainer');
            const video = document.getElementById('giftVideo');
            const playButton = document.getElementById('giftPlayButton');

            video.src = giftVideoUrl;
            video.muted = false;
            video.load();
            
            overlay.classList.add('active');
            container.classList.remove('exit');
            playButton.classList.remove('show');

            video.play().then(() => {
                playButton.classList.remove('show');
            }).catch(() => {
                playButton.classList.add('show');
            });

            video.onended = () => {
                container.classList.add('exit');
                setTimeout(() => {
                    overlay.classList.remove('active');
                    video.pause();
                    video.currentTime = 0;
                }, 500);
            };
        }

        function manualPlayGiftVideo() {
            const video = document.getElementById('giftVideo');
            const playButton = document.getElementById('giftPlayButton');
            
            video.muted = false;
            video.play().then(() => {
                playButton.classList.remove('show');
            });
        }

        function closeGiftVideo() {
            const overlay = document.getElementById('giftVideoOverlay');
            const container = document.getElementById('giftVideoContainer');
            const video = document.getElementById('giftVideo');

            container.classList.add('exit');
            setTimeout(() => {
                overlay.classList.remove('active');
                video.pause();
                video.currentTime = 0;
            }, 500);
        }

        // ============================================
        // DUAA FUNCTIONS
        // ============================================
        function openDuaaOverlay() {
            const overlay = document.getElementById('duaaOverlay');
            overlay.classList.add('active');
            currentDuaaIndex = 0;
            renderDuaa();
        }

        function closeDuaaOverlay(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('duaaOverlay').classList.remove('active');
        }

        function renderDuaa() {
            const content = document.getElementById('duaaContent');
            
            if (allDuaas.length === 0) {
                content.innerHTML = `
                    <div class="duaa-empty">
                        <div class="duaa-empty-icon"></div>
                        <p>No duaa added yet</p>
                    </div>
                `;
                return;
            }
            
            const duaa = allDuaas[currentDuaaIndex];
            
            content.innerHTML = `
                <div class="duaa-content">
                    <div class="duaa-text">${duaa.arabic_text || duaa.duaa_text}</div>
                    ${duaa.translation ? `<div class="duaa-translation">${duaa.translation}</div>` : ''}
                </div>
                <div class="duaa-nav">
                    <button class="duaa-nav-btn" onclick="prevDuaa()" ${currentDuaaIndex === 0 ? 'disabled' : ''}> Previous</button>
                    <span class="duaa-counter">${currentDuaaIndex + 1} / ${allDuaas.length}</span>
                    <button class="duaa-nav-btn" onclick="nextDuaa()" ${currentDuaaIndex === allDuaas.length - 1 ? 'disabled' : ''}>Next </button>
                </div>
            `;
        }

        function nextDuaa() {
            if (currentDuaaIndex < allDuaas.length - 1) {
                currentDuaaIndex++;
                renderDuaa();
            }
        }

        function prevDuaa() {
            if (currentDuaaIndex > 0) {
                currentDuaaIndex--;
                renderDuaa();
            }
        }

        // ============================================
        // WELCOME FUNCTIONS
        // ============================================
        function closeWelcome() {
            document.getElementById('welcomeOverlay').classList.remove('active');
        }

        // ============================================
        // DAY FUNCTIONS
        // ============================================
        async function openDay(id, dayNumber) {
            try {
                const { data: day, error: dayError } = await supabase
                    .from('days')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (dayError) throw dayError;

                const { data: parts, error: partsError } = await supabase
                    .from('day_parts')
                    .select('*')
                    .eq('day_id', id)
                    .order('part_order');

                if (partsError) throw partsError;

                dayData = {
                    ...day,
                    day_parts: parts || []
                };
                currentDay = dayNumber;
                currentDayNumber = dayNumber;
                currentPart = 0;
                
                await loadProgressNote(dayNumber);
                
                document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
                
                document.getElementById('messagePartsContainer').classList.remove('hidden');
                document.getElementById('stickyNoteContainer').classList.remove('active');
                document.getElementById('progressNoteView').classList.remove('active');
                document.getElementById('progressToggleBtn').classList.remove('active');
                
                showMessage();
            } catch (error) {
                console.error('Error loading day:', error);
                alert('Error loading day: ' + error.message);
            }
        }

        function showMessage() {
            if (!dayData || !dayData.day_parts || dayData.day_parts.length === 0) {
                document.getElementById('messageContent').textContent = 'No messages for this day yet.';
                document.getElementById('messageOverlay').classList.add('active');
                document.getElementById('messageDisplay').classList.add('active');
                return;
            }

            const part = dayData.day_parts[currentPart];
            const totalParts = dayData.day_parts.length;

            document.getElementById('messageDayBadge').textContent = `Day ${currentDay}`;
            document.getElementById('messageContent').textContent = part.text;
            document.getElementById('partIndicator').textContent = `Part ${currentPart + 1} of ${totalParts}`;
            
            const imgEl = document.getElementById('messageImage');
            if (part.image_url) {
                imgEl.src = part.image_url;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }

            const voiceContainer = document.getElementById('messageVoiceContainer');
            if (part.voice_url) {
                voiceContainer.innerHTML = `
                    <div class="voice-player">
                        <button class="voice-play-btn" onclick="toggleMessageVoice()">
                            <span id="msgVoicePlayIcon"></span>
                        </button>
                        <div class="voice-progress-container">
                            <div class="voice-progress-bar" onclick="seekMessageVoice(event)">
                                <div class="voice-progress-fill" id="msgVoiceProgressFill"></div>
                            </div>
                            <div class="voice-time">
                                <span id="msgVoiceCurrentTime">0:00</span>
                                <span id="msgVoiceDuration">0:00</span>
                            </div>
                        </div>
                    </div>
                    <audio id="msgVoiceAudio" src="${part.voice_url}" style="display: none;"></audio>
                `;
                voiceContainer.style.display = 'block';
                setTimeout(() => initMessageVoicePlayer(), 100);
            } else {
                voiceContainer.innerHTML = '';
                voiceContainer.style.display = 'none';
            }

            const nextBtn = document.getElementById('nextBtn');
            if (currentPart >= totalParts - 1) {
                nextBtn.innerHTML = 'Close ';
                nextBtn.onclick = closeMessage;
            } else {
                nextBtn.innerHTML = 'Next <span></span>';
                nextBtn.onclick = nextPart;
            }

            document.getElementById('messageOverlay').classList.add('active');
            document.getElementById('messageDisplay').classList.add('active');
        }

        function initMessageVoicePlayer() {
            const audio = document.getElementById('msgVoiceAudio');
            if (!audio) return;

            audio.addEventListener('loadedmetadata', () => {
                const duration = document.getElementById('msgVoiceDuration');
                if (duration) duration.textContent = formatTime(audio.duration);
            });

            audio.addEventListener('timeupdate', () => {
                const progressFill = document.getElementById('msgVoiceProgressFill');
                const currentTime = document.getElementById('msgVoiceCurrentTime');
                if (progressFill && audio.duration) {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    progressFill.style.width = progress + '%';
                }
                if (currentTime) {
                    currentTime.textContent = formatTime(audio.currentTime);
                }
            });

            audio.addEventListener('ended', () => {
                const playIcon = document.getElementById('msgVoicePlayIcon');
                if (playIcon) playIcon.textContent = '';
            });
        }

        function toggleMessageVoice() {
            const audio = document.getElementById('msgVoiceAudio');
            const playIcon = document.getElementById('msgVoicePlayIcon');
            
            if (!audio) return;

            if (audio.paused) {
                audio.play();
                playIcon.textContent = '';
            } else {
                audio.pause();
                playIcon.textContent = '';
            }
        }

        function seekMessageVoice(event) {
            const audio = document.getElementById('msgVoiceAudio');
            const progressBar = event.currentTarget;
            if (!audio || !progressBar) return;

            const rect = progressBar.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audio.currentTime = percent * audio.duration;
        }

        function nextPart() {
            if (dayData && currentPart < dayData.day_parts.length - 1) {
                currentPart++;
                showMessage();
            }
        }

        function closeMessage() {
            const audio = document.getElementById('msgVoiceAudio');
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
            
            document.getElementById('messageOverlay').classList.remove('active');
            document.getElementById('messageDisplay').classList.remove('active');
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('messagePartsContainer').classList.remove('hidden');
            document.getElementById('stickyNoteContainer').classList.remove('active');
            document.getElementById('progressNoteView').classList.remove('active');
            document.getElementById('progressToggleBtn').classList.remove('active');
            
            currentDay = null;
            currentDayNumber = null;
            currentPart = 0;
            dayData = null;
            currentProgressNote = null;
        }

        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // ============================================
        // PROGRESS NOTE FUNCTIONS
        // ============================================
        async function toggleProgress() {
            const partsContainer = document.getElementById('messagePartsContainer');
            const stickyNoteContainer = document.getElementById('stickyNoteContainer');
            const progressNoteView = document.getElementById('progressNoteView');
            const toggleBtn = document.getElementById('progressToggleBtn');
            
            if (!partsContainer.classList.contains('hidden')) {
                if (currentProgressNote) {
                    document.getElementById('progressNoteContent').textContent = currentProgressNote;
                    partsContainer.classList.add('hidden');
                    progressNoteView.classList.add('active');
                    toggleBtn.classList.add('active');
                    toggleBtn.innerHTML = ' View Message';
                } else {
                    partsContainer.classList.add('hidden');
                    stickyNoteContainer.classList.add('active');
                    document.getElementById('progressTextarea').value = '';
                    toggleBtn.innerHTML = ' View Message';
                }
            } else {
                partsContainer.classList.remove('hidden');
                stickyNoteContainer.classList.remove('active');
                progressNoteView.classList.remove('active');
                toggleBtn.classList.remove('active');
                
                if (currentProgressNote) {
                    toggleBtn.innerHTML = ' View Progress';
                } else {
                    toggleBtn.innerHTML = ' Add Progress';
                }
            }
        }

        async function saveProgress() {
            const progressText = document.getElementById('progressTextarea').value.trim();
            
            if (!progressText) {
                alert('Please write something before saving! ');
                return;
            }
            
            if (!currentDayNumber) {
                alert('Error: No day selected');
                return;
            }

            try {
                const { error } = await supabase
                    .from('progress_notes')
                    .upsert({
                        day_number: currentDayNumber,
                        note: progressText,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'day_number' });

                if (error) throw error;

                currentProgressNote = progressText;
                dayProgressNotes.set(currentDayNumber, progressText);
                
                document.getElementById('stickyNoteContainer').classList.remove('active');
                document.getElementById('progressNoteContent').textContent = progressText;
                document.getElementById('progressNoteView').classList.add('active');
                document.getElementById('progressToggleBtn').innerHTML = ' View Message';
                document.getElementById('progressToggleBtn').classList.add('active');
                
                await renderDays();
                
                alert('Progress saved!  Keep up the great work, Aiko! ');
            } catch (error) {
                console.error('Error saving progress:', error);
                alert('Error saving progress: ' + error.message);
            }
        }

        function cancelProgress() {
            document.getElementById('stickyNoteContainer').classList.remove('active');
            document.getElementById('messagePartsContainer').classList.remove('hidden');
            document.getElementById('progressToggleBtn').classList.remove('active');
            
            if (currentProgressNote) {
                document.getElementById('progressToggleBtn').innerHTML = ' View Progress';
            } else {
                document.getElementById('progressToggleBtn').innerHTML = ' Add Progress';
            }
        }

        function editProgress() {
            document.getElementById('progressNoteView').classList.remove('active');
            document.getElementById('stickyNoteContainer').classList.add('active');
            document.getElementById('progressTextarea').value = currentProgressNote || '';
        }

        async function loadProgressNote(dayNumber) {
            try {
                const { data, error } = await supabase
                    .from('progress_notes')
                    .select('*')
                    .eq('day_number', dayNumber)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading progress note:', error);
                }

                if (data && data.note) {
                    currentProgressNote = data.note;
                    dayProgressNotes.set(dayNumber, data.note);
                    document.getElementById('progressToggleBtn').innerHTML = ' View Progress';
                    return true;
                } else {
                    currentProgressNote = null;
                    document.getElementById('progressToggleBtn').innerHTML = ' Add Progress';
                    return false;
                }
            } catch (error) {
                console.error('Error loading progress note:', error);
                return false;
            }
        }

        async function loadAllProgressNotes() {
            try {
                const { data, error } = await supabase
                    .from('progress_notes')
                    .select('*');

                if (error) throw error;

                dayProgressNotes.clear();
                if (data) {
                    data.forEach(note => {
                        dayProgressNotes.set(note.day_number, note.note);
                    });
                }
            } catch (error) {
                console.error('Error loading all progress notes:', error);
            }
        }

        // ============================================
        // NOTIFICATION MESSAGES FUNCTIONS
        // ============================================
        async function loadMessages() {
            try {
                const { data, error } = await supabase
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (error) throw error;

                allMessages = data || [];
                updateNotificationBadge();
                
                console.log('Loaded', allMessages.length, 'messages');
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notifBadge');
            const btn = document.getElementById('notifBtn');

            if (allMessages.length > 0) {
                badge.textContent = allMessages.length;
                badge.style.display = 'flex';
                btn.classList.add('has-messages');
                btn.classList.add('visible');
            } else {
                badge.style.display = 'none';
                btn.classList.remove('has-messages');
                btn.classList.remove('visible');
            }
        }

        function toggleMessages() {
            const container = document.getElementById('messagesContainer');
            messagesOpen = !messagesOpen;

            if (messagesOpen) {
                displayMessages();
                container.classList.add('active');
            } else {
                hideMessages();
            }
        }

        async function deleteViewedMessages() {
            if (allMessages.length === 0) return;

            try {
                const messageIds = allMessages.map(msg => msg.id);

                const { error } = await supabase
                    .from('messages')
                    .delete()
                    .in('id', messageIds);

                if (error) {
                    console.error('Error deleting viewed messages:', error);
                    return;
                }

                allMessages = [];
                updateNotificationBadge();

            } catch (error) {
                console.error('Error in deleteViewedMessages:', error);
            }
        }

        function displayMessages() {
            const container = document.getElementById('messagesContainer');

            if (allMessages.length === 0) {
                container.innerHTML = '';
                container.classList.remove('active');
                return;
            }

            container.innerHTML = '';
            
            allMessages.forEach((message, index) => {
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.style.animationDelay = `${index * 0.1}s`;
                
                const time = new Date(message.created_at);
                const timeStr = time.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit'
                });
                
                bubble.innerHTML = `
                    <span class="message-bubble-icon"></span>
                    <p class="message-bubble-text">${message.message_text}</p>
                    <span class="message-bubble-time">${timeStr}</span>
                `;
                
                container.appendChild(bubble);
            });
        }

        function hideMessages() {
            const container = document.getElementById('messagesContainer');
            const bubbles = container.querySelectorAll('.message-bubble');
            
            bubbles.forEach((bubble, index) => {
                setTimeout(() => {
                    bubble.classList.add('closing');
                }, index * 50);
            });
            
            setTimeout(() => {
                container.classList.remove('active');
                deleteViewedMessages();
            }, bubbles.length * 50 + 300);
        }

        document.addEventListener('click', (e) => {
            if (messagesOpen) {
                const container = document.getElementById('messagesContainer');
                const btn = document.getElementById('notifBtn');
                
                if (!container.contains(e.target) && !btn.contains(e.target)) {
                    hideMessages();
                    messagesOpen = false;
                }
            }
        });

        // ============================================
        // TO-DO LIST & GPA FUNCTIONS
        // ============================================
        function openTodoModal() {
            document.getElementById('todoModalOverlay').classList.add('active');
            loadCurrentTodoList();
            calculateGPA();
        }

        function closeTodoModal() {
            document.getElementById('todoModalOverlay').classList.remove('active');
        }

        async function loadCurrentTodoList() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                const { data, error } = await supabase
                    .from('daily_todos')
                    .select('*, todo_items(*)')
                    .eq('date', today)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading todo list:', error);
                }

                if (data) {
                    currentTodoList = data;
                    displayTodoList();
                } else {
                    currentTodoList = null;
                    showEditMode();
                }
            } catch (error) {
                console.error('Error:', error);
                currentTodoList = null;
                showEditMode();
            }
        }

        function showEditMode() {
            document.getElementById('todoEditArea').classList.add('active');
            document.getElementById('todoViewArea').classList.add('hidden');
            document.getElementById('todoTextarea').value = '';
            updateDateLabel();
        }

        function showViewMode() {
            document.getElementById('todoEditArea').classList.remove('active');
            document.getElementById('todoViewArea').classList.remove('hidden');
        }

        function updateDateLabel() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateStr = today.toLocaleDateString('en-US', options);
            document.getElementById('todoDateLabel').textContent = dateStr;
            document.getElementById('todoViewDateLabel').textContent = dateStr;
        }

        async function submitTodoList() {
            const textarea = document.getElementById('todoTextarea');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('Please write at least one task! ');
                return;
            }

            const tasks = text.split('\n').filter(line => line.trim());
            
            if (tasks.length === 0) {
                alert('Please write at least one task! ');
                return;
            }

            try {
                const today = new Date().toISOString().split('T')[0];

                if (currentTodoList) {
                    await supabase.from('daily_todos').delete().eq('id', currentTodoList.id);
                }

                const { data: todoList, error: listError } = await supabase
                    .from('daily_todos')
                    .insert({
                        date: today,
                        total_tasks: tasks.length
                    })
                    .select()
                    .single();

                if (listError) throw listError;

                const todoItems = tasks.map((task, index) => ({
                    todo_list_id: todoList.id,
                    task_text: task.trim(),
                    task_order: index + 1,
                    completed: false
                }));

                const { error: itemsError } = await supabase
                    .from('todo_items')
                    .insert(todoItems);

                if (itemsError) throw itemsError;

                alert('To-do list saved!  You got this, Aiko! ');
                await loadCurrentTodoList();
                await calculateGPA();
                
            } catch (error) {
                console.error('Error saving todo list:', error);
                alert('Error saving list: ' + error.message);
            }
        }

        function displayTodoList() {
            if (!currentTodoList || !currentTodoList.todo_items || currentTodoList.todo_items.length === 0) {
                document.getElementById('todoListContainer').innerHTML = `
                    <div class="todo-empty-state">
                        <div class="todo-empty-state-icon"></div>
                        <p>No tasks for today!</p>
                    </div>
                `;
                showViewMode();
                return;
            }

            const items = currentTodoList.todo_items.sort((a, b) => a.task_order - b.task_order);
            
            const isRTL = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/.test(items[0].task_text);
            
            const html = items.map((item, index) => `
                <div class="todo-item ${item.completed ? 'completed' : ''}" dir="${isRTL ? 'rtl' : 'ltr'}">
                    <div class="todo-item-number">${index + 1}</div>
                    <input 
                        type="checkbox" 
                        class="todo-checkbox" 
                        ${item.completed ? 'checked' : ''}
                        onchange="toggleTodoItem(${item.id}, this.checked)"
                    >
                    <span class="todo-item-text">${item.task_text}</span>
                </div>
            `).join('');

            document.getElementById('todoListContainer').innerHTML = html;
            showViewMode();
            updateDateLabel();
        }

        async function toggleTodoItem(itemId, completed) {
            try {
                const { error } = await supabase
                    .from('todo_items')
                    .update({ completed: completed })
                    .eq('id', itemId);

                if (error) throw error;

                await loadCurrentTodoList();
                await calculateGPA();

                if (completed) {
                    const encouragements = [
                        "Great job! ",
                        "You're crushing it! ",
                        "One step closer! ",
                        "Amazing work! ",
                        "Keep it up! "
                    ];
                    const random = encouragements[Math.floor(Math.random() * encouragements.length)];
                    showQuickMessage(random);
                }
                
            } catch (error) {
                console.error('Error updating task:', error);
            }
        }

        function showQuickMessage(message) {
            const div = document.createElement('div');
            div.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, var(--primary), var(--secondary));
                color: white;
                padding: 15px 30px;
                border-radius: 25px;
                font-weight: 700;
                z-index: 9999;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
                animation: slideUp 0.5s ease;
            `;
            div.textContent = message;
            document.body.appendChild(div);
            
            setTimeout(() => {
                div.style.animation = 'slideDown 0.5s ease';
                setTimeout(() => div.remove(), 500);
            }, 2000);
        }

        function editTodoList() {
            if (!currentTodoList) return;
            
            const tasks = currentTodoList.todo_items
                .sort((a, b) => a.task_order - b.task_order)
                .map(item => item.task_text)
                .join('\n');
            
            document.getElementById('todoTextarea').value = tasks;
            showEditMode();
        }

        async function startNewTodoList() {
            if (!currentTodoList) {
                showEditMode();
                return;
            }

            const confirmed = confirm('Start a new to-do list? This will save your current progress to GPA and create a fresh list! ');
            if (!confirmed) return;

            await calculateGPA();
            
            currentTodoList = null;
            showEditMode();
            document.getElementById('todoTextarea').value = '';
            
            alert('New day, new goals!  Let\'s do this, Aiko! ');
        }

        async function calculateGPA() {
            try {
                const { data: allLists, error } = await supabase
                    .from('daily_todos')
                    .select('*, todo_items(*)');

                if (error) throw error;

                allTodoLists = allLists || [];

                let totalTasks = 0;
                let completedTasks = 0;

                allTodoLists.forEach(list => {
                    if (list.todo_items) {
                        totalTasks += list.todo_items.length;
                        completedTasks += list.todo_items.filter(item => item.completed).length;
                    }
                });

                const incompleteTasks = totalTasks - completedTasks;
                const completionRate = totalTasks > 0 ? completedTasks / totalTasks : 0;
                const gpa = completionRate * 4.0;

                document.getElementById('totalTasks').textContent = totalTasks;
                document.getElementById('completedTasks').textContent = completedTasks;
                document.getElementById('incompleteTasks').textContent = incompleteTasks;
                document.getElementById('gpaText').textContent = gpa.toFixed(2);

                updateGPACircle(gpa);

            } catch (error) {
                console.error('Error calculating GPA:', error);
            }
        }

        function updateGPACircle(gpa) {
            const circle = document.getElementById('gpaCircle');
            const circumference = 2 * Math.PI * 65;
            const percentage = (gpa / 4.0) * 100;
            const offset = circumference - (percentage / 100) * circumference;

            circle.style.strokeDashoffset = offset;

            let color;
            if (gpa >= 3.5) {
                color = '#00b894';
            } else if (gpa >= 3.0) {
                color = '#55efc4';
            } else if (gpa >= 2.5) {
                color = '#ffeaa7';
            } else if (gpa >= 2.0) {
                color = '#fdcb6e';
            } else {
                color = '#ff7675';
            }

            circle.style.stroke = color;
            document.getElementById('gpaText').style.color = color;
        }

        async function loadAllTodos() {
            await calculateGPA();
        }
    </script>
</body>
</html>
